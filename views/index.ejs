<h2>LEETCOIN Connect 4</h2>
<a href="https://github.com/leetcoin/">source code available</a><br>
<br><br>
<h3>The wager is 100 Satoshi</h3>
<br>
<h3>Match <%= game.id %></h3>
<br><br>

<div id='other-player' style='display:none'>
  Waiting for another player to join.<br>
</div>

<div id='your-move-X' style='display:none'>
  Your move! Click a column to drop an 'X'.
</div>
<div id='your-move-O' style='display:none'>
  Your move! Click a column to drop an 'O'.
</div>
<div id='their-move' style='display:none'>
  Waiting for other player to move...
</div>
<div id='draw'>
  Draw game!
</div>
<div id='you-won'>
  You won this game!
</div>
<div id='you-lost'>
  You lost this game.
</div>

<!--
<div id='board' class='drop'>

  <div class='t l r cell'id='5-0'></div>
  <div class='t c cell'  id='5-1'></div>
  <div class='t r cell'  id='5-2'></div>
  <div class='t r cell'  id='5-3'></div>
  <div class='t r cell'  id='5-4'></div>
  <div class='t r cell'  id='5-5'></div>
  <div class='t l r cell'id='5-6'></div>
  
  
  
  <div class='t l r cell'id='4-0'></div>
  <div class='t c cell'  id='4-1'></div>
  <div class='t r cell'  id='4-2'></div>
  <div class='t r cell'  id='4-3'></div>
  <div class='t r cell'  id='4-4'></div>
  <div class='t r cell'  id='4-5'></div>
  <div class='t l r cell'id='4-6'></div>
  
  
  
  <div class='t l r cell'id='3-0'></div>
  <div class='t c cell'  id='3-1'></div>
  <div class='t r cell'  id='3-2'></div>
  <div class='t r cell'  id='3-3'></div>
  <div class='t r cell'  id='3-4'></div>
  <div class='t r cell'  id='3-5'></div>
  <div class='t l r cell'id='3-6'></div>
  
  
  
  <div class='t l r cell'id='2-0'></div>
  <div class='t c cell'  id='2-1'></div>
  <div class='t r cell'  id='2-2'></div>
  <div class='t r cell'  id='2-3'></div>
  <div class='t r cell'  id='2-4'></div>
  <div class='t r cell'  id='2-5'></div>
  <div class='t l r cell'id='2-6'></div>
  
  
  
  <div class='t l r cell'id='1-0'></div>
  <div class='t c cell'  id='1-1'></div>
  <div class='t r cell'  id='1-2'></div>
  <div class='t r cell'  id='1-3'></div>
  <div class='t r cell'  id='1-4'></div>
  <div class='t r cell'  id='1-5'></div>
  <div class='t l r cell'id='1-6'></div>
  
  
  
  <div class='t l r cell'id='0-0'></div>
  <div class='t c cell'  id='0-1'></div>
  <div class='t r cell'  id='0-2'></div>
  <div class='t r cell'  id='0-3'></div>
  <div class='t r cell'  id='0-4'></div>
  <div class='t r cell'  id='0-5'></div>
  <div class='t l r cell'id='0-6'></div>
  
  
</div>

-->


<div id='board' class='drop'>

  <div class="col">
    <div class='t l r cell'><span id='5-0'></span></div>
    <div class='t l r cell'><span id='4-0'></span></div>
    <div class='t l r cell'><span id='3-0'></span></div>
    <div class='t l r cell'><span id='2-0'></span></div>
    <div class='t l r cell'><span id='1-0'></span></div>
    <div class='t l r cell'><span id='0-0'></span></div>
  </div>
  
  <div class="col"> 
    <div class='t c cell'  ><span id='5-1'></span></div>
    <div class='t c cell'  ><span id='4-1'></span></div>
    <div class='t c cell'  ><span id='3-1'></span></div>
    <div class='t c cell'  ><span id='2-1'></span></div>
    <div class='t c cell'  ><span id='1-1'></span></div>
    <div class='t c cell'  ><span id='0-1'></span></div>
  </div>
  
  <div class="col">
    <div class='t r cell'  ><span id='5-2'></span></div>
    <div class='t r cell'  ><span id='4-2'></span></div>
    <div class='t r cell'  ><span id='3-2'></span></div>
    <div class='t r cell'  ><span id='2-2'></span></div>
    <div class='t r cell'  ><span id='1-2'></span></div>
    <div class='t r cell'  ><span id='0-2'></span></div>
  </div>
  
  <div class="col">
    <div class='t r cell'  ><span id='5-3'></span></div>
    <div class='t r cell'  ><span id='4-3'></span></div>
    <div class='t r cell'  ><span id='3-3'></span></div>
    <div class='t r cell'  ><span id='2-3'></span></div>
    <div class='t r cell'  ><span id='1-3'></span></div>
    <div class='t r cell'  ><span id='0-3'></span></div>
  </div>
  
  <div class="col">
    <div class='t r cell'  ><span id='5-4'></span></div>
    <div class='t r cell'  ><span id='4-4'></span></div>
    <div class='t r cell'  ><span id='3-4'></span></div>
    <div class='t r cell'  ><span id='2-4'></span></div>
    <div class='t r cell'  ><span id='1-4'></span></div>
    <div class='t r cell'  ><span id='0-4'></span></div>
  </div>
  
  <div class="col">
    <div class='t r cell'  ><span id='5-5'></span></div>
    <div class='t r cell'  ><span id='4-5'></span></div>
    <div class='t r cell'  ><span id='3-5'></span></div>
    <div class='t r cell'  ><span id='2-5'></span></div>
    <div class='t r cell'  ><span id='1-5'></span></div>
    <div class='t r cell'  ><span id='0-5'></span></div>
  </div>
  
  <div class="col">
    <div class='t l r cell'><span id='5-6'></span></div>
    <div class='t l r cell'><span id='4-6'></span></div>
    <div class='t l r cell'><span id='3-6'></span></div>
    <div class='t l r cell'><span id='2-6'></span></div>
    <div class='t l r cell'><span id='1-6'></span></div>
    <div class='t l r cell'><span id='0-6'></span></div>
  </div>
  
  
  
</div>



<br><br>
<!-- a href="/logout">Log Out</a -->


<script src="/socket.io/socket.io.js"></script>
<script type='text/javascript'>
  function updateGame() {      
    var game = state.game;
    for (var n = 0; n < game.board.length; n++) {
      for (var m = 0; m < game.nRows; m++) {
        var square = document.getElementById(m + '-' + n);
        //square.innerHTML = game.board[n][m] || ' ';
        
        //square.style.background = "transparent";
        if (game.board[n][m] == 'X') {
          square.innerHTML = '&#9679';
          square.style.color = '#0575EB'
        } else if (game.board[n][m] == 'O') {
          
          square.innerHTML = '&#9679';
          
          square.style.color = '#83DF55'
        }
      }
    }

    if (!!game.winner && !!game.winVector) {
      for(var i = 0; i < game.winVector.length; i++) {
        var n = game.winVector[i][0];
        var m = game.winVector[i][1];
        var square = document.getElementById(m + '-' + n);
        if (game.winner == state.userId) {
          //square.style.background = "green";
        } else {
          //square.style.background = "red";
        }
      }
    }

    var display = {
      'board': 'flex',
      'your-move-X': 'none',
      'your-move-O': 'none',
      'their-move': 'none',
      'other-player': 'none',
      'draw': 'none',
      'you-won': 'none',
      'you-lost': 'none'
    }; 

    if (!game.player1 || !game.player2) {
      display['other-player'] = 'block';
      display['board'] = 'none';
    } else if (game.winner == state.userId) {
      display['you-won'] = 'block';
    } else if (game.winner) {
      display['you-lost'] = 'block';
    } else if (game.draw) {
      display['draw'] = 'block';
    } else if (isMyMove()) {
      if(game.player1 == state.userId) display['your-move-X'] = 'block';
      else display['your-move-O'] = 'block';
    } else {
      display['their-move'] = 'block';
    }

    console.log(game)

    for (var label in display) {
      document.getElementById(label).style.display = display[label];
    }
  };

  function isMyMove() {
    var game = state.game;
    return game[game.turn] == state.userId;
  }

  function moveInColumn(n) {
    socket.emit('move', n);      
  }

  function highlightColumn(n) {
    var game = state.game;

    if(!isMyMove() || game.winner) return;
    
    for (var _n = 0; _n < game.board.length; _n++) {
      for (var _m = 0; _m < game.nRows; _m++) {
        if (n == _n) {
          color = 'lightblue';
        } else {
          color = 'white';
        }

        //document.getElementById(_m + '-' + _n).style.background = color;
      }
    }
    
    
    
    
    /*
    for (var _n = 0; _n < game.board.length; _n++) {
      for (var _m = 0; _m < game.nRows; _m++) {
        
        var thisSquare = String('#' + _m + '-' + _n)
        
        if (n == _n) {
          bgClass = 'highlight';
        } else {
          bgClass = 'none';
        }
        
        $(thisSquare).toggleClass(bgClass)
        console.log(thisSquare)
        
        //document.getElementById(_m + '-' + _n).style.background = bg;
      }
    }
    */
    
    
  }

  var state = {
    userId: '<%= userId %>',
    game: <%- JSON.stringify(game) %>
  };

  var socket = io.connect('/<%= game.id %>');
  
  socket.on('game', function(game) {
    state.game = game;
    updateGame();
  });
  
  updateGame();
  
  var game = state.game;
  for (var n = 0; n < game.board.length; n++) {
    for (var m = 0; m < game.nRows; m++) {
      var square = document.getElementById(m + '-' + n);
      square.onmouseover = new Function('highlightColumn(' + n + ')');
      square.onclick = new Function('moveInColumn(' + n + ')');
    }
  }
</script>
